<!-- index.html (–≤–µ—Ä—Å–∏—è 5.0, Full-Featured SPA) -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ë–æ—Ç–æ–≤</title>
    <style>
        :root {
            --button-color: var(--tg-theme-button-color, #5288c1);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
        }
        body { font-family: -apple-system, sans-serif; background-color: var(--tg-theme-bg-color, #212121); color: var(--tg-theme-text-color, #ffffff); margin: 0; padding: 15px; }
        .screen { display: none; } /* –í—Å–µ —ç–∫—Ä–∞–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã */
        .screen.active { display: block; } /* –ê–∫—Ç–∏–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è */
        h1, h2 { margin-top: 0; }
        .bot-list, .section-list { display: flex; flex-direction: column; gap: 10px; }
        .list-item { background-color: var(--tg-theme-secondary-bg-color, #333); border-radius: 8px; padding: 12px 15px; cursor: pointer; transition: background-color 0.2s; font-size: 16px; display: flex; justify-content: space-between; align-items: center;}
        .delete-btn { color: #ff453a; font-weight: bold; cursor: pointer; padding: 5px; }
        button { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; background-color: var(--button-color); color: var(--button-text-color); cursor: pointer; margin-top: 15px;}
        .button-secondary { background-color: #555; }
        input[type="text"], textarea { width: 100%; padding: 10px; background-color: var(--tg-theme-secondary-bg-color, #444); color: var(--tg-theme-text-color, #fff); border: 1px solid #555; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px;}
        textarea { min-height: 120px; }
        label { display: block; margin-bottom: 5px; color: var(--tg-theme-hint-color, #aaa); }
        p { color: var(--tg-theme-hint-color, #aaa); }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù 1: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (—Å–ø–∏—Å–æ–∫ –±–æ—Ç–æ–≤) -->
    <div id="screen-main" class="screen active">
        <h1>–ú–æ–∏ –±–æ—Ç—ã</h1>
        <div id="bot-list-container" class="bot-list">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        <button id="btn-show-add-bot">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞</button>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞ -->
    <div id="screen-add-bot" class="screen">
        <h2>–ù–æ–≤—ã–π –±–æ—Ç</h2>
        <label for="input-token">–¢–æ–∫–µ–Ω –±–æ—Ç–∞</label>
        <input type="text" id="input-token" placeholder="123456:ABC-DEF1234567890">
        <button id="btn-submit-token">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="button-secondary btn-back" data-target="screen-main">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- –≠–ö–†–ê–ù 3: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ -->
    <div id="screen-config-bot" class="screen">
        <h2 id="config-bot-title"></h2>
        <div id="section-list-container" class="section-list"></div>
        <button id="btn-show-add-section">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</button>
        <button class="button-secondary btn-back" data-target="screen-main">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –±–æ—Ç–æ–≤</button>
    </div>

    <!-- –≠–ö–†–ê–ù 4: –†–µ–¥–∞–∫—Ç–æ—Ä —Å–µ–∫—Ü–∏–∏ -->
    <div id="screen-edit-section" class="screen">
        <h2 id="edit-section-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
        <label for="input-section-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ (–¥–ª—è –Ω–æ–≤—ã—Ö)</label>
        <input type="text" id="input-section-name">
        <label for="input-section-content">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
        <textarea id="input-section-content" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –ø–æ–∫–∞ —É–±—Ä–∞–Ω–∞ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è, —Ç.–∫. —Ç—Ä–µ–±—É–µ—Ç —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ -->
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö.</p>
        <button id="btn-save-section">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="button-secondary btn-back" data-target="screen-config-bot">–û—Ç–º–µ–Ω–∞</button>
    </div>


    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            if (!window.Telegram || !window.Telegram.WebApp) {
                document.body.innerHTML = '<p>–≠—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram.</p>';
                return;
            }

            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            let currentBotId = null;
            let currentSectionId = null;

            // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è ---
            const screens = document.querySelectorAll('.screen');
            function showScreen(screenId) {
                screens.forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            }

            document.querySelectorAll('.btn-back').forEach(btn => {
                btn.onclick = () => showScreen(btn.dataset.target);
            });

            // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
            document.getElementById('btn-show-add-bot').onclick = () => showScreen('screen-add-bot');

            document.getElementById('btn-submit-token').onclick = () => {
                const token = document.getElementById('input-token').value;
                if (!token) {
                    tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω.');
                    return;
                }
                tg.showConfirm(`–î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º: ${token.substring(0, 10)}...?`, (ok) => {
                    if (ok) {
                        tg.sendData(JSON.stringify({ command: 'submit_token', token: token }));
                    }
                });
            };

            document.getElementById('btn-show-add-section').onclick = () => {
                currentSectionId = 'new';
                document.getElementById('edit-section-title').innerText = '–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª';
                document.getElementById('input-section-name').value = '';
                document.getElementById('input-section-content').value = '';
                document.getElementById('input-section-name').style.display = 'block';
                showScreen('screen-edit-section');
            };

            document.getElementById('btn-save-section').onclick = () => {
                const content = document.getElementById('input-section-content').value;
                const buttonName = document.getElementById('input-section-name').value;

                if (currentSectionId === 'new' && !buttonName) {
                    tg.showAlert('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');
                    return;
                }

                tg.sendData(JSON.stringify({
                    command: 'save_section',
                    bot_id: currentBotId,
                    section_id: currentSectionId,
                    button_name: buttonName,
                    content_text: content,
                }));
            };

            // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö ---
            function renderBots(bots) {
                const container = document.getElementById('bot-list-container');
                container.innerHTML = '';
                if (!bots || bots.length === 0) {
                    container.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–æ—Ç–æ–≤.</p>';
                } else {
                    bots.forEach(bot => {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerText = `@${bot.username}`;
                        div.onclick = () => {
                            currentBotId = bot.id;
                            tg.sendData(JSON.stringify({ command: 'get_bot_details', bot_id: bot.id }));
                        };
                        container.appendChild(div);
                    });
                }
            }

            function renderBotConfig(data) {
                document.getElementById('config-bot-title').innerText = `–ù–∞—Å—Ç—Ä–æ–π–∫–∞ @${data.username}`;
                const container = document.getElementById('section-list-container');
                container.innerHTML = '';

                // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'list-item';
                welcomeDiv.innerText = '‚úèÔ∏è –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ';
                welcomeDiv.onclick = () => {
                    currentSectionId = 0; // 0 - id –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
                    document.getElementById('edit-section-title').innerText = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ';
                    document.getElementById('input-section-name').style.display = 'none';
                    document.getElementById('input-section-content').value = data.welcome_message || '';
                    showScreen('screen-edit-section');
                };
                container.appendChild(welcomeDiv);

                // –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å–µ–∫—Ü–∏–∏
                data.sections.forEach(sec => {
                    const secDiv = document.createElement('div');
                    secDiv.className = 'list-item';

                    const nameSpan = document.createElement('span');
                    nameSpan.innerText = `‚úèÔ∏è ${sec.button_name}`;
                    nameSpan.onclick = () => {
                         currentSectionId = sec.section_id;
                         document.getElementById('edit-section-title').innerText = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å "${sec.button_name}"`;
                         document.getElementById('input-section-name').style.display = 'none';
                         document.getElementById('input-section-content').value = sec.content_text || '';
                         showScreen('screen-edit-section');
                    };

                    const delSpan = document.createElement('span');
                    delSpan.className = 'delete-btn';
                    delSpan.innerText = 'üóëÔ∏è';
                    delSpan.onclick = (e) => {
                        e.stopPropagation();
                        tg.showConfirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª "${sec.button_name}"?`, (ok) => {
                           if (ok) tg.sendData(JSON.stringify({ command: 'delete_section', section_id: sec.section_id, bot_id: currentBotId }));
                        });
                    };

                    secDiv.appendChild(nameSpan);
                    secDiv.appendChild(delSpan);
                    container.appendChild(secDiv);
                });
                showScreen('screen-config-bot');
            }


            // --- –°–≤—è–∑—å —Å –±—ç–∫–µ–Ω–¥–æ–º ---
            tg.onEvent('web_app_data_received', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'my_bots_list':
                            renderBots(data.bots);
                            break;
                        case 'bot_details':
                            renderBotConfig(data.details);
                            break;
                        case 'action_success':
                            tg.showAlert(data.message);
                            // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω
                            if (data.next_screen === 'main') {
                                tg.sendData(JSON.stringify({ command: 'get_my_bots' })); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                                showScreen('screen-main');
                            } else if (data.next_screen === 'config') {
                                tg.sendData(JSON.stringify({ command: 'get_bot_details', bot_id: currentBotId }));
                            }
                            break;
                        case 'action_error':
                            tg.showAlert(`–û—à–∏–±–∫–∞: ${data.message}`);
                            break;
                    }
                } catch (e) {
                    console.error('Failed to parse data from bot:', e);
                    tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö.');
                }
            });

            // --- –ù–∞—á–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å ---
            tg.sendData(JSON.stringify({ command: 'get_my_bots' }));
        });
    </script>
</body>
</html>