<!-- index.html (версия 5.0, Full-Featured SPA) -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Конструктор Ботов</title>
    <style>
        :root {
            --button-color: var(--tg-theme-button-color, #5288c1);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
        }
        body { font-family: -apple-system, sans-serif; background-color: var(--tg-theme-bg-color, #212121); color: var(--tg-theme-text-color, #ffffff); margin: 0; padding: 15px; }
        .screen { display: none; } /* Все экраны по умолчанию скрыты */
        .screen.active { display: block; } /* Активный экран показывается */
        h1, h2 { margin-top: 0; }
        .bot-list, .section-list { display: flex; flex-direction: column; gap: 10px; }
        .list-item { background-color: var(--tg-theme-secondary-bg-color, #333); border-radius: 8px; padding: 12px 15px; cursor: pointer; transition: background-color 0.2s; font-size: 16px; display: flex; justify-content: space-between; align-items: center;}
        .delete-btn { color: #ff453a; font-weight: bold; cursor: pointer; padding: 5px; }
        button { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; background-color: var(--button-color); color: var(--button-text-color); cursor: pointer; margin-top: 15px;}
        .button-secondary { background-color: #555; }
        input[type="text"], textarea { width: 100%; padding: 10px; background-color: var(--tg-theme-secondary-bg-color, #444); color: var(--tg-theme-text-color, #fff); border: 1px solid #555; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px;}
        textarea { min-height: 120px; }
        label { display: block; margin-bottom: 5px; color: var(--tg-theme-hint-color, #aaa); }
        p { color: var(--tg-theme-hint-color, #aaa); }
    </style>
</head>
<body>

    <!-- ЭКРАН 1: Главное меню (список ботов) -->
    <div id="screen-main" class="screen active">
        <h1>Мои боты</h1>
        <div id="bot-list-container" class="bot-list">
            <p>Загрузка...</p>
        </div>
        <button id="btn-show-add-bot">➕ Добавить нового бота</button>
    </div>

    <!-- ЭКРАН 2: Добавление нового бота -->
    <div id="screen-add-bot" class="screen">
        <h2>Новый бот</h2>
        <label for="input-token">Токен бота</label>
        <input type="text" id="input-token" placeholder="123456:ABC-DEF1234567890">
        <button id="btn-submit-token">Сохранить</button>
        <button class="button-secondary btn-back" data-target="screen-main">Назад</button>
    </div>

    <!-- ЭКРАН 3: Конфигурация бота -->
    <div id="screen-config-bot" class="screen">
        <h2 id="config-bot-title"></h2>
        <div id="section-list-container" class="section-list"></div>
        <button id="btn-show-add-section">➕ Добавить новый раздел</button>
        <button class="button-secondary btn-back" data-target="screen-main">Назад к списку ботов</button>
    </div>

    <!-- ЭКРАН 4: Редактор секции -->
    <div id="screen-edit-section" class="screen">
        <h2 id="edit-section-title">Редактирование</h2>
        <label for="input-section-name">Название кнопки (для новых)</label>
        <input type="text" id="input-section-name">
        <label for="input-section-content">Текст сообщения</label>
        <textarea id="input-section-content" placeholder="Введите текст..."></textarea>
        <!-- Загрузка фото пока убрана для упрощения, т.к. требует сложной логики -->
        <p>Загрузка фото будет доступна в следующих версиях.</p>
        <button id="btn-save-section">Сохранить</button>
        <button class="button-secondary btn-back" data-target="screen-config-bot">Отмена</button>
    </div>


    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            if (!window.Telegram || !window.Telegram.WebApp) {
                document.body.innerHTML = '<p>Это веб-приложение предназначено для запуска только внутри Telegram.</p>';
                return;
            }

            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            let currentBotId = null;
            let currentSectionId = null;

            // --- Навигация ---
            const screens = document.querySelectorAll('.screen');
            function showScreen(screenId) {
                screens.forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            }

            document.querySelectorAll('.btn-back').forEach(btn => {
                btn.onclick = () => showScreen(btn.dataset.target);
            });

            // --- Обработчики событий ---
            document.getElementById('btn-show-add-bot').onclick = () => showScreen('screen-add-bot');

            document.getElementById('btn-submit-token').onclick = () => {
                const token = document.getElementById('input-token').value;
                if (!token) {
                    tg.showAlert('Пожалуйста, введите токен.');
                    return;
                }
                tg.showConfirm(`Добавить бота с токеном: ${token.substring(0, 10)}...?`, (ok) => {
                    if (ok) {
                        tg.sendData(JSON.stringify({ command: 'submit_token', token: token }));
                    }
                });
            };

            document.getElementById('btn-show-add-section').onclick = () => {
                currentSectionId = 'new';
                document.getElementById('edit-section-title').innerText = 'Новый раздел';
                document.getElementById('input-section-name').value = '';
                document.getElementById('input-section-content').value = '';
                document.getElementById('input-section-name').style.display = 'block';
                showScreen('screen-edit-section');
            };

            document.getElementById('btn-save-section').onclick = () => {
                const content = document.getElementById('input-section-content').value;
                const buttonName = document.getElementById('input-section-name').value;

                if (currentSectionId === 'new' && !buttonName) {
                    tg.showAlert('Название кнопки не может быть пустым.');
                    return;
                }

                tg.sendData(JSON.stringify({
                    command: 'save_section',
                    bot_id: currentBotId,
                    section_id: currentSectionId,
                    button_name: buttonName,
                    content_text: content,
                }));
            };

            // --- Рендеринг данных ---
            function renderBots(bots) {
                const container = document.getElementById('bot-list-container');
                container.innerHTML = '';
                if (!bots || bots.length === 0) {
                    container.innerHTML = '<p>У вас пока нет ботов.</p>';
                } else {
                    bots.forEach(bot => {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerText = `@${bot.username}`;
                        div.onclick = () => {
                            currentBotId = bot.id;
                            tg.sendData(JSON.stringify({ command: 'get_bot_details', bot_id: bot.id }));
                        };
                        container.appendChild(div);
                    });
                }
            }

            function renderBotConfig(data) {
                document.getElementById('config-bot-title').innerText = `Настройка @${data.username}`;
                const container = document.getElementById('section-list-container');
                container.innerHTML = '';

                // Приветствие
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'list-item';
                welcomeDiv.innerText = '✏️ Приветствие';
                welcomeDiv.onclick = () => {
                    currentSectionId = 0; // 0 - id для приветствия
                    document.getElementById('edit-section-title').innerText = 'Редактировать приветствие';
                    document.getElementById('input-section-name').style.display = 'none';
                    document.getElementById('input-section-content').value = data.welcome_message || '';
                    showScreen('screen-edit-section');
                };
                container.appendChild(welcomeDiv);

                // Кастомные секции
                data.sections.forEach(sec => {
                    const secDiv = document.createElement('div');
                    secDiv.className = 'list-item';

                    const nameSpan = document.createElement('span');
                    nameSpan.innerText = `✏️ ${sec.button_name}`;
                    nameSpan.onclick = () => {
                         currentSectionId = sec.section_id;
                         document.getElementById('edit-section-title').innerText = `Редактировать "${sec.button_name}"`;
                         document.getElementById('input-section-name').style.display = 'none';
                         document.getElementById('input-section-content').value = sec.content_text || '';
                         showScreen('screen-edit-section');
                    };

                    const delSpan = document.createElement('span');
                    delSpan.className = 'delete-btn';
                    delSpan.innerText = '🗑️';
                    delSpan.onclick = (e) => {
                        e.stopPropagation();
                        tg.showConfirm(`Удалить раздел "${sec.button_name}"?`, (ok) => {
                           if (ok) tg.sendData(JSON.stringify({ command: 'delete_section', section_id: sec.section_id, bot_id: currentBotId }));
                        });
                    };

                    secDiv.appendChild(nameSpan);
                    secDiv.appendChild(delSpan);
                    container.appendChild(secDiv);
                });
                showScreen('screen-config-bot');
            }


            // --- Связь с бэкендом ---
            tg.onEvent('web_app_data_received', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'my_bots_list':
                            renderBots(data.bots);
                            break;
                        case 'bot_details':
                            renderBotConfig(data.details);
                            break;
                        case 'action_success':
                            tg.showAlert(data.message);
                            // После успешного действия возвращаемся и обновляем нужный экран
                            if (data.next_screen === 'main') {
                                tg.sendData(JSON.stringify({ command: 'get_my_bots' })); // Обновляем список
                                showScreen('screen-main');
                            } else if (data.next_screen === 'config') {
                                tg.sendData(JSON.stringify({ command: 'get_bot_details', bot_id: currentBotId }));
                            }
                            break;
                        case 'action_error':
                            tg.showAlert(`Ошибка: ${data.message}`);
                            break;
                    }
                } catch (e) {
                    console.error('Failed to parse data from bot:', e);
                    tg.showAlert('Произошла ошибка обработки данных.');
                }
            });

            // --- Начальный запрос ---
            tg.sendData(JSON.stringify({ command: 'get_my_bots' }));
        });
    </script>
</body>
</html>